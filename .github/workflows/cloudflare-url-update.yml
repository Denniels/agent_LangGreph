name: ğŸ”„ Smart Cloudflare URL Detection

on:
  schedule:
    # Ejecutar cada 10 minutos (mÃ¡s conservador para evitar lÃ­mites)
    - cron: '*/10 * * * *'
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forzar detecciÃ³n y actualizaciÃ³n de URLs'
        required: false
        default: false
        type: boolean
      test_mode:
        description: 'Modo de prueba (no actualizar archivos)'
        required: false
        default: false
        type: boolean

  # Ejecutar cuando se detecten cambios en archivos de configuraciÃ³n
  push:
    paths:
      - 'cloudflare_urls.json'
      - 'modules/utils/ultra_robust_cloudflare_manager.py'
      - '.github/workflows/cloudflare-url-update.yml'

jobs:
  update-cloudflare-urls:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: ğŸ” Detect Cloudflare URL changes
      id: detect_changes
      run: |
        echo "ğŸš€ Starting smart Cloudflare URL detection..."
        
        # Instalar dependencias adicionales si es necesario
        pip install beautifulsoup4
        
        # Crear script de detecciÃ³n en lÃ­nea
        cat > detect_cloudflare_url.py << 'EOF'
        import requests
        import json
        import re
        import time
        from datetime import datetime
        
        def detect_current_url():
            """Detectar URL actual usando mÃºltiples estrategias."""
            
            # URLs candidatas conocidas para probar
            candidate_urls = [
                "https://returned-convenience-tower-switched.trycloudflare.com",
                "https://reflect-wed-governmental-fisher.trycloudflare.com", 
                "https://replica-subscriber-permission-restricted.trycloudflare.com",
            ]
            
            print("ğŸ” Probando URLs candidatas...")
            
            working_urls = []
            for url in candidate_urls:
                try:
                    response = requests.get(f"{url}/health", timeout=10)
                    if response.status_code == 200:
                        working_urls.append(url)
                        print(f"  âœ… Funciona: {url}")
                    else:
                        print(f"  ğŸŸ¡ HTTP {response.status_code}: {url}")
                except Exception as e:
                    print(f"  âŒ Error: {url} - {str(e)[:50]}")
            
            if working_urls:
                return working_urls[0]  # Retornar la primera que funcione
            
            print("âš ï¸ Ninguna URL candidata funciona, intentando descubrimiento...")
            
            # TODO: AquÃ­ se podrÃ­an agregar mÃ¡s mÃ©todos de descubrimiento
            # Por ahora retornamos None
            return None
        
        def load_current_config():
            """Cargar configuraciÃ³n actual."""
            try:
                with open('cloudflare_urls.json', 'r') as f:
                    return json.load(f)
            except:
                return {"current_url": None}
        
        def save_config(config):
            """Guardar configuraciÃ³n actualizada."""
            config['last_updated'] = datetime.now().isoformat()
            with open('cloudflare_urls.json', 'w') as f:
                json.dump(config, f, indent=2)
        
        # DetecciÃ³n principal
        detected_url = detect_current_url()
        current_config = load_current_config()
        current_url = current_config.get('current_url')
        
        print(f"\nğŸ“Š RESULTADOS:")
        print(f"  URL actual en config: {current_url}")
        print(f"  URL detectada: {detected_url}")
        
        # Determinar si hay cambios
        if detected_url and detected_url != current_url:
            print("ğŸš¨ CAMBIO DETECTADO!")
            
            # Actualizar configuraciÃ³n
            current_config['current_url'] = detected_url
            current_config['metadata'] = {
                'detection_method': 'github_actions_discovery',
                'confident': True,
                'tested': True,
                'previous_url': current_url
            }
            
            # Actualizar backup_urls
            if 'backup_urls' not in current_config:
                current_config['backup_urls'] = []
            
            if detected_url not in current_config['backup_urls']:
                current_config['backup_urls'].insert(0, detected_url)
            
            # Mantener solo las Ãºltimas 5 URLs
            current_config['backup_urls'] = current_config['backup_urls'][:5]
            
            save_config(current_config)
            
            print("âœ… ConfiguraciÃ³n actualizada")
            return True
        else:
            print("â„¹ï¸ No hay cambios")
            return False
        
        if __name__ == "__main__":
            has_changes = detect_current_url()
            exit(0 if has_changes else 1)
        EOF
        
        # Ejecutar detecciÃ³n
        python detect_cloudflare_url.py
        DETECTION_RESULT=$?
        
        # Verificar si hay cambios en git
        if git diff --quiet cloudflare_urls.json; then
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "âœ… No changes in configuration"
        else
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "ğŸš¨ Configuration updated!"
          
          # Mostrar cambios
          echo "Changes in cloudflare_urls.json:"
          git diff cloudflare_urls.json
        fi

    - name: ğŸ“Š Generate change report
      if: steps.detect_changes.outputs.changes_detected == 'true'
      run: |
        echo "## ğŸ”„ Cloudflare URL Update Report" > update_report.md
        echo "" >> update_report.md
        echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> update_report.md
        echo "" >> update_report.md
        
        # Obtener la URL actual
        python -c "
        try:
            from modules.utils.jetson_url_config import get_current_jetson_url
            print(f'**New URL:** {get_current_jetson_url()}')
        except Exception as e:
            print(f'**Error getting URL:** {e}')
        " >> update_report.md
        
        echo "" >> update_report.md
        echo "**Files modified:**" >> update_report.md
        git diff --name-only | sed 's/^/- /' >> update_report.md
        
        echo "" >> update_report.md
        echo "**Triggered by:** GitHub Actions (Automated)" >> update_report.md
        echo "" >> update_report.md
        echo "---" >> update_report.md
        echo "*This update was performed automatically by the Cloudflare URL monitoring system.*" >> update_report.md

    - name: ğŸ”§ Configure Git
      if: steps.detect_changes.outputs.changes_detected == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Cloudflare URL Auto-Update"

    - name: ğŸ’¾ Commit and push changes
      if: steps.detect_changes.outputs.changes_detected == 'true'
      run: |
        # Agregar todos los archivos modificados
        git add .
        
        # Obtener informaciÃ³n para el commit
        CURRENT_URL=$(python -c "
        try:
            from modules.utils.jetson_url_config import get_current_jetson_url
            print(get_current_jetson_url())
        except:
            print('unknown-url')
        ")
        
        COMMIT_MSG="ğŸ”„ Auto-update Cloudflare URL to ${CURRENT_URL}

        - Detected URL change via automated monitoring
        - Updated all references automatically
        - Triggered at $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - Auto-generated by GitHub Actions"
        
        # Hacer commit
        git commit -m "$COMMIT_MSG"
        
        echo "âœ… Changes committed successfully"

    - name: ğŸš€ Push changes
      if: steps.detect_changes.outputs.changes_detected == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}

    - name: ğŸ“¢ Post-update notification
      if: steps.detect_changes.outputs.changes_detected == 'true'
      run: |
        echo "ğŸ‰ Cloudflare URL update completed successfully!"
        echo "ğŸ“Š Summary:"
        echo "  - New URL detected and updated"
        echo "  - All files synchronized"
        echo "  - Changes pushed to repository"
        echo "  - Streamlit Cloud will auto-deploy new version"
        
        # Validar que el sistema funcione
        python -c "
        try:
            from modules.utils.jetson_url_config import validate_jetson_url, get_current_jetson_url
            url = get_current_jetson_url()
            valid = validate_jetson_url()
            print(f'âœ… Final validation: URL {url} is {'valid' if valid else 'invalid'}')
        except Exception as e:
            print(f'âŒ Validation error: {e}')
        "

    - name: â„¹ï¸ No changes notification
      if: steps.detect_changes.outputs.changes_detected == 'false'
      run: |
        echo "â„¹ï¸ No Cloudflare URL changes detected"
        echo "âœ… System is up to date"
        
        # Mostrar estado actual
        python -c "
        try:
            from modules.utils.jetson_url_config import get_current_jetson_url, validate_jetson_url
            url = get_current_jetson_url()
            valid = validate_jetson_url()
            print(f'ğŸ“Š Current URL: {url}')
            print(f'ğŸ” Status: {'healthy' if valid else 'unhealthy'}')
        except Exception as e:
            print(f'âŒ Error: {e}')
        "

  # Job adicional para notificaciones (opcional)
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: update-cloudflare-urls
    if: failure()
    
    steps:
    - name: ğŸš¨ Failure notification
      run: |
        echo "âŒ Cloudflare URL update failed!"
        echo "ğŸ”§ Manual intervention may be required"
        echo "ğŸ“… Failed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        # AquÃ­ se puede agregar notificaciÃ³n a Slack, Discord, etc.
        # Por ejemplo (requiere configurar SLACK_WEBHOOK_URL en secrets):
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ğŸš¨ Cloudflare URL update failed in agent_LangGreph"}' \
        #   "$SLACK_WEBHOOK_URL"